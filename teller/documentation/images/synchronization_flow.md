# Synchronization Flow Diagrams

## Branch to HQ Synchronization Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              BRANCH SYSTEM                               │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  1. Transaction completed in ERPNext
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  PostgreSQL │───▶│ Transaction │───▶│  Database   │───▶│  Sync Outbox│
│  Database   │    │   Trigger   │    │   Change    │    │    Table    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  2. Changes captured in outbox
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Outbox     │───▶│  Debezium   │───▶│   Kafka     │───▶│ Branch Kafka│
│  Processor  │    │  Connector  │    │  Producer   │    │   Topics    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  3. Changes published to Kafka
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  4. Events transmitted over secure VPN
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                             HQ SYSTEM                                    │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ HQ Kafka    │───▶│   Kafka     │───▶│  Conflict   │───▶│ Transformation│
│  Topics     │    │  Consumer   │    │  Detection  │    │   Service   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  5. Data transformed and conflicts resolved
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Data Apply  │───▶│ Transaction │───▶│  HQ         │───▶│ Confirmation │
│  Service    │    │  Manager    │    │ PostgreSQL  │    │   Service   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  6. Confirmation sent back to branch
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  7. Confirmation transmitted over secure VPN
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Confirmation │───▶│  Mark Sync  │───▶│  Clean Up   │
│  Receiver   │    │  Complete   │    │   Outbox    │
└─────────────┘    └─────────────┘    └─────────────┘
```

## HQ to Branch Synchronization Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                HQ SYSTEM                                 │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  1. Master data updated in HQ (e.g., exchange rates)
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  HQ         │───▶│ Transaction │───▶│  Database   │───▶│  HQ Outbox  │
│  PostgreSQL │    │   Trigger   │    │   Change    │    │    Table    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  2. Changes captured in outbox
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Outbox     │───▶│  Debezium   │───▶│   Kafka     │───▶│  HQ Kafka   │
│  Processor  │    │  Connector  │    │  Producer   │    │   Topics    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  3. Changes published to Kafka topics for each branch
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  4. Events transmitted over secure VPN to all branches
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              BRANCH SYSTEM                               │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Branch Kafka│───▶│   Kafka     │───▶│  Validation │───▶│ Branch-specific│
│  Topics     │    │  Consumer   │    │   Service   │    │  Transform   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  5. Data validated and transformed for branch
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Data Apply  │───▶│ Transaction │───▶│  Branch     │───▶│ Confirmation │
│  Service    │    │  Manager    │    │ PostgreSQL  │    │   Service   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  6. Confirmation sent back to HQ
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  7. Confirmation transmitted over secure VPN
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Confirmation │───▶│  Update     │───▶│  Branch     │
│  Receiver   │    │  Status     │    │  Registry   │
└─────────────┘    └─────────────┘    └─────────────┘
```

## Branch to Branch Communication Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            SOURCE BRANCH SYSTEM                          │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  1. Inter-branch transaction initiated
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  ERPNext    │───▶│ Transaction │───▶│  API        │───▶│  Request    │
│  Interface  │    │  Formatter  │    │  Gateway    │    │  Encryption │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  2. Encrypted request prepared
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  3. Request transmitted to HQ over secure VPN
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                HQ SYSTEM                                 │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ HQ API      │───▶│ Request     │───▶│ Transaction │───▶│  Routing    │
│ Gateway     │    │ Validation  │    │  Logging    │    │  Service    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  4. Request validated, logged, and routed
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  5. Request forwarded to destination branch
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         DESTINATION BRANCH SYSTEM                        │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Branch API  │───▶│ Request     │───▶│ Permission  │───▶│ Transaction │
│ Gateway     │    │ Decryption  │    │  Check      │    │  Processor  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  6. Transaction processed at destination
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Transaction │───▶│  Branch     │───▶│  Response   │───▶│  Response   │
│  Execution  │    │ PostgreSQL  │    │  Formatter  │    │  Encryption │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  7. Encrypted response prepared
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  8. Response transmitted back through HQ
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                HQ SYSTEM                                 │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  9. Response logged and forwarded
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  10. Response returned to source branch
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Response    │───▶│ Response    │───▶│ Transaction │───▶│  ERPNext    │
│ Receiver    │    │ Decryption  │    │  Completion │    │  Interface  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
``` 