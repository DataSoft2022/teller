<!DOCTYPE html>
<html>
<head>
    <title>Synchronization Flows for Multi-Branch Banking System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.5; }
        h1 { color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h2 { color: #3498db; margin-top: 30px; }
        h3 { color: #2980b9; }
        pre { background-color: #f8f8f8; border: 1px solid #ddd; padding: 10px; border-radius: 5px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Synchronization Flows for Multi-Branch Banking System</h1><h1>Synchronization Flow Diagrams</h1>
<p></p>
<h2>Branch to HQ Synchronization Flow</h2>
<p></p>
<pre>
┌─────────────────────────────────────────────────────────────────────────┐
│                              BRANCH SYSTEM                               │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  1. Transaction completed in ERPNext
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  PostgreSQL │───▶│ Transaction │───▶│  Database   │───▶│  Sync Outbox│
│  Database   │    │   Trigger   │    │   Change    │    │    Table    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  2. Changes captured in outbox
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Outbox     │───▶│  Debezium   │───▶│   Kafka     │───▶│ Branch Kafka│
│  Processor  │    │  Connector  │    │  Producer   │    │   Topics    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  3. Changes published to Kafka
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  4. Events transmitted over secure VPN
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                             HQ SYSTEM                                    │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ HQ Kafka    │───▶│   Kafka     │───▶│  Conflict   │───▶│ Transformation│
│  Topics     │    │  Consumer   │    │  Detection  │    │   Service   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  5. Data transformed and conflicts resolved
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Data Apply  │───▶│ Transaction │───▶│  HQ         │───▶│ Confirmation │
│  Service    │    │  Manager    │    │ PostgreSQL  │    │   Service   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  6. Confirmation sent back to branch
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  7. Confirmation transmitted over secure VPN
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Confirmation │───▶│  Mark Sync  │───▶│  Clean Up   │
│  Receiver   │    │  Complete   │    │   Outbox    │
└─────────────┘    └─────────────┘    └─────────────┘
</pre>
<p></p>
<h2>HQ to Branch Synchronization Flow</h2>
<p></p>
<pre>
┌─────────────────────────────────────────────────────────────────────────┐
│                                HQ SYSTEM                                 │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  1. Master data updated in HQ (e.g., exchange rates)
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  HQ         │───▶│ Transaction │───▶│  Database   │───▶│  HQ Outbox  │
│  PostgreSQL │    │   Trigger   │    │   Change    │    │    Table    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  2. Changes captured in outbox
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Outbox     │───▶│  Debezium   │───▶│   Kafka     │───▶│  HQ Kafka   │
│  Processor  │    │  Connector  │    │  Producer   │    │   Topics    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  3. Changes published to Kafka topics for each branch
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  4. Events transmitted over secure VPN to all branches
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              BRANCH SYSTEM                               │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Branch Kafka│───▶│   Kafka     │───▶│  Validation │───▶│ Branch-specific│
│  Topics     │    │  Consumer   │    │   Service   │    │  Transform   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  5. Data validated and transformed for branch
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Data Apply  │───▶│ Transaction │───▶│  Branch     │───▶│ Confirmation │
│  Service    │    │  Manager    │    │ PostgreSQL  │    │   Service   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  6. Confirmation sent back to HQ
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  7. Confirmation transmitted over secure VPN
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Confirmation │───▶│  Update     │───▶│  Branch     │
│  Receiver   │    │  Status     │    │  Registry   │
└─────────────┘    └─────────────┘    └─────────────┘
</pre>
<p></p>
<h2>Branch to Branch Communication Flow</h2>
<p></p>
<pre>
┌─────────────────────────────────────────────────────────────────────────┐
│                            SOURCE BRANCH SYSTEM                          │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  1. Inter-branch transaction initiated
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  ERPNext    │───▶│ Transaction │───▶│  API        │───▶│  Request    │
│  Interface  │    │  Formatter  │    │  Gateway    │    │  Encryption │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  2. Encrypted request prepared
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  3. Request transmitted to HQ over secure VPN
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                HQ SYSTEM                                 │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ HQ API      │───▶│ Request     │───▶│ Transaction │───▶│  Routing    │
│ Gateway     │    │ Validation  │    │  Logging    │    │  Service    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  4. Request validated, logged, and routed
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  5. Request forwarded to destination branch
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         DESTINATION BRANCH SYSTEM                        │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Branch API  │───▶│ Request     │───▶│ Permission  │───▶│ Transaction │
│ Gateway     │    │ Decryption  │    │  Check      │    │  Processor  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  6. Transaction processed at destination
                                                               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Transaction │───▶│  Branch     │───▶│  Response   │───▶│  Response   │
│  Execution  │    │ PostgreSQL  │    │  Formatter  │    │  Encryption │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
                                                               │  7. Encrypted response prepared
                                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  8. Response transmitted back through HQ
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                HQ SYSTEM                                 │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  9. Response logged and forwarded
   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SECURE VPN TUNNEL                             │
└─────────────────────────────────────────────────────────────────────────┘
   │
   │  10. Response returned to source branch
   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Response    │───▶│ Response    │───▶│ Transaction │───▶│  ERPNext    │
│ Receiver    │    │ Decryption  │    │  Completion │    │  Interface  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
</pre>
</body>
</html>
